<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>قنوات Xtream عبر البروكسي</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Tahoma,Arial; background:#0b0f17; color:#e9edf1; margin:0}
  header{padding:16px; background:#111827; border-bottom:1px solid #1f2937}
  .row{display:flex; gap:12px; flex-wrap:wrap; align-items:center}
  input,button,select{padding:10px 12px; border-radius:10px; border:1px solid #374151; background:#0f172a; color:#e5e7eb}
  button{cursor:pointer}
  button.primary{background:#2563eb; border-color:#1d4ed8}
  main{display:grid; grid-template-columns: 320px 1fr; gap:14px; padding:14px}
  @media (max-width: 950px){ main{display:block} }
  .panel{background:#0f172a; border:1px solid #1f2937; border-radius:14px; padding:12px}
  .list{display:grid; gap:8px}
  .chips{display:flex; gap:8px; flex-wrap:wrap; max-height:46vh; overflow:auto; padding:6px}
  .chip{border:1px solid #334155; background:#0b1220; border-radius:999px; padding:8px 12px; white-space:nowrap}
  .chip.active{background:#1d4ed8; border-color:#1d4ed8}
  .search{display:flex; gap:8px}
  .items{max-height:54vh; overflow:auto; padding-right:4px}
  .item{display:flex; align-items:center; gap:10px; padding:10px; border-radius:10px; border:1px solid #1f2937; background:#0b1220}
  .item:hover{background:#0d1528}
  .badge{font-size:12px; opacity:.75}
  video{width:100%; max-height:62vh; background:#000; border-radius:12px; border:1px solid #1f2937}
  .muted{opacity:.7; font-size:13px}
  a{color:#93c5fd; text-decoration:none}
</style>
</head>
<body>
<header>
  <div class="row">
    <strong>🎯 Xtream عبر Cloudflare Worker</strong>
    <span class="muted" id="topNote">— يتعرّف تلقائيًا على الإعدادات من السيرفر</span>
  </div>
</header>

<main>
  <section class="panel">
    <h3>إعدادات Xtream</h3>
    <div class="row" style="margin-top:8px">
      <input id="host" placeholder="host:port (مثال mhiptv.info:2095)" style="flex:1">
    </div>
    <div class="row">
      <input id="user" placeholder="اسم المستخدم u">
      <input id="pass" placeholder="كلمة المرور p" type="password">
      <button id="save" class="primary">حفظ / تحديث</button>
    </div>
    <p class="muted">تُحفظ محليًا ولن تحتاج إدخالها مرة أخرى.</p>
    <h3 style="margin-top:10px">التصنيفات</h3>
    <div id="cats" class="chips"></div>
  </section>

  <section class="panel">
    <div class="row" style="justify-content:space-between">
      <h3>المشغل</h3>
      <div class="muted" id="status">جارِ التحميل…</div>
    </div>
    <video id="player" controls playsinline></video>

    <div class="row search" style="margin-top:10px">
      <input id="q" placeholder="ابحث باسم القناة..." style="flex:1">
      <select id="sort">
        <option value="name">الاسم (أ-ي)</option>
        <option value="id">حسب المعرّف</option>
      </select>
    </div>

    <h4 style="margin:10px 0 6px">القنوات</h4>
    <div id="streams" class="items list"></div>
  </section>
</main>

<script>
const $ = (id)=>document.getElementById(id);
const state = { host:"", u:"", p:"", catId:null, allStreams:[], baseProxy:"" };

function setStatus(m){ $("status").textContent = m; }
function canNativeHLS(){ const v=document.createElement("video"); return v.canPlayType('application/vnd.apple.mpegURL') || v.canPlayType('application/x-mpegURL'); }

async function boot(){
  try{
    const info = await (await fetch("/api/xtream/ping")).json();
    if(info.base_proxy) state.baseProxy = info.base_proxy;
    state.host = localStorage.getItem("xt_host") || info.host || "";
    state.u    = localStorage.getItem("xt_u")    || "";
    state.p    = localStorage.getItem("xt_p")    || "";
    $("host").value = state.host;
    $("user").value = state.u;
    $("pass").value = state.p;
  }catch(e){ console.warn(e); }
  setStatus("جاهز"); loadCategories();
}

$("save").onclick = ()=>{
  state.host = $("host").value.trim();
  state.u    = $("user").value.trim();
  state.p    = $("pass").value.trim();
  localStorage.setItem("xt_host", state.host);
  localStorage.setItem("xt_u", state.u);
  localStorage.setItem("xt_p", state.p);
  loadCategories();
};

async function loadCategories(){
  if(!(state.host&&state.u&&state.p)){ setStatus("أدخل بيانات Xtream ثم اضغط حفظ"); $("cats").innerHTML=""; $("streams").innerHTML=""; return; }
  setStatus("جلب التصنيفات…"); $("cats").innerHTML="…";
  const cats = await (await fetch(`/api/xtream/categories?host=${encodeURIComponent(state.host)}&u=${encodeURIComponent(state.u)}&p=${encodeURIComponent(state.p)}`)).json();
  $("cats").innerHTML = "";
  (cats||[]).forEach(c=>{
    const b=document.createElement("button");
    b.className="chip"; b.textContent=c.category_name||("تصنيف #"+c.category_id);
    b.onclick=()=>selectCategory(c.category_id,b);
    $("cats").appendChild(b);
  });
  setStatus("اختر تصنيفًا");
}

async function selectCategory(category_id, btn){
  [...document.querySelectorAll(".chip")].forEach(x=>x.classList.remove("active"));
  btn.classList.add("active");
  setStatus("جلب القنوات…"); $("streams").innerHTML="…";
  const data = await (await fetch(`/api/xtream/channels?category_id=${encodeURIComponent(category_id)}&host=${encodeURIComponent(state.host)}&u=${encodeURIComponent(state.u)}&p=${encodeURIComponent(state.p)}`)).json();
  state.allStreams = (data && data.channels) ? data.channels : [];
  renderStreams(); setStatus(`تم — ${state.allStreams.length} قناة`);
}

$("q").oninput = renderStreams; $("sort").onchange = renderStreams;
function renderStreams(){
  const q=$("q").value.trim().toLowerCase(), sort=$("sort").value;
  let items = state.allStreams.slice();
  if(q) items = items.filter(s => (s.name||"").toLowerCase().includes(q));
  items.sort((a,b)=> sort==="id" ? (+a.stream_id||0)-(+b.stream_id||0) : (a.name||"").localeCompare(b.name||"") );
  $("streams").innerHTML="";
  items.forEach(s=>{
    const div=document.createElement("div"); div.className="item";
    const name=document.createElement("div"); name.style.flex="1"; name.textContent=s.name||"بدون اسم";
    const badge=document.createElement("div"); badge.className="badge"; badge.textContent="#"+s.stream_id;
    const btn=document.createElement("button"); btn.textContent="تشغيل ▶"; btn.onclick=()=>play(s.stream_id);
    div.appendChild(name); div.appendChild(badge); div.appendChild(btn); $("streams").appendChild(div);
  });
}

async function play(stream_id){
  const hlsUrl = `/api/xtream/stream/${encodeURIComponent(stream_id)}.m3u8?host=${encodeURIComponent(state.host)}&u=${encodeURIComponent(state.u)}&p=${encodeURIComponent(state.p)}`;
  const video = $("player");
  if (canNativeHLS()){ video.src=hlsUrl; video.play().catch(()=>{}); return; }
  if (!window.Hls){
    await new Promise((ok,err)=>{ const s=document.createElement("script"); s.src="https://cdn.jsdelivr.net/npm/hls.js@latest"; s.onload=ok; s.onerror=err; document.head.appendChild(s); });
  }
  if (window.Hls && window.Hls.isSupported()){
    const hls = new Hls(); hls.loadSource(hlsUrl); hls.attachMedia(video);
    hls.on(Hls.Events.MANIFEST_PARSED, ()=> video.play().catch(()=>{}));
  } else { video.src=hlsUrl; video.play().catch(()=>{}); }
}
boot();
</script>
</body>
</html>
