<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ù‚Ù†ÙˆØ§Øª Xtream Ø¹Ø¨Ø± Ø§Ù„Ø¨Ø±ÙˆÙƒØ³ÙŠ</title>
<style>
  :root { color-scheme: dark; }
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Tahoma,Arial; background:#0b0f17; color:#e9edf1; margin:0}
  header{padding:16px; background:#111827; border-bottom:1px solid #1f2937}
  .row{display:flex; gap:12px; flex-wrap:wrap; align-items:center}
  input,button,select{padding:10px 12px; border-radius:10px; border:1px solid #374151; background:#0f172a; color:#e5e7eb}
  button{cursor:pointer}
  button.primary{background:#2563eb; border-color:#1d4ed8}
  button.outline{background:transparent}
  button:disabled{opacity:.5; cursor:not-allowed}
  main{display:grid; grid-template-columns: 320px 1fr; gap:14px; padding:14px}
  @media (max-width: 950px){ main{display:block} }
  .panel{background:#0f172a; border:1px solid #1f2937; border-radius:14px; padding:12px}
  .list{display:grid; gap:8px}
  .chips{display:flex; gap:8px; flex-wrap:wrap; max-height:46vh; overflow:auto; padding:6px}
  .chip{border:1px solid #334155; background:#0b1220; border-radius:999px; padding:8px 12px; white-space:nowrap}
  .chip.active{background:#1d4ed8; border-color:#1d4ed8}
  .search{display:flex; gap:8px}
  .items{max-height:54vh; overflow:auto; padding-right:4px}
  .item{display:flex; align-items:center; gap:10px; padding:10px; border-radius:10px; border:1px solid #1f2937; background:#0b1220}
  .item:hover{background:#0d1528}
  .badge{font-size:12px; opacity:.75}
  video{width:100%; max-height:62vh; background:#000; border-radius:12px; border:1px solid #1f2937}
  .muted{opacity:.7; font-size:13px}
  a{color:#93c5fd; text-decoration:none}
  .status{font-size:13px; opacity:.8}
  .toast{position:fixed; inset-inline-start:12px; inset-block-end:12px; background:#111827; border:1px solid #374151; padding:10px 12px; border-radius:10px}
</style>
</head>
<body>
<header>
  <div class="row">
    <strong>ğŸ¯ Xtream Ø¹Ø¨Ø± Cloudflare Worker</strong>
    <span class="muted">â€” Ø£Ø¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³ÙŠØ±ÙØ± Ø£Ùˆ Ù…Ø±Ù‘Ø±Ù‡Ø§ ÙÙŠ Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙØ­Ø©</span>
  </div>
</header>

<main>
  <!-- Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø£ÙŠØ³Ø±: Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„ØªØµÙ†ÙŠÙØ§Øª -->
  <section class="panel">
    <h3>Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Xtream</h3>
    <div class="row" style="margin-top:8px">
      <input id="host" placeholder="host:port (Ù…Ø«Ø§Ù„ mhiptv.info:2095)" style="flex:1">
    </div>
    <div class="row">
      <input id="user" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… u" inputmode="numeric">
      <input id="pass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± p" type="password" inputmode="numeric">
      <button id="save" class="primary">Ø­ÙØ¸ / ØªØ­Ø¯ÙŠØ«</button>
    </div>
    <p class="muted">ÙŠÙ…ÙƒÙ†Ùƒ Ø£ÙŠØ¶Ø§ ÙØªØ­ Ø§Ù„ØµÙØ­Ø© Ù‡ÙƒØ°Ø§:<br>
      <code>?host=HOST:PORT&u=USER&p=PASS</code>
    </p>

    <h3 style="margin-top:10px">Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª</h3>
    <div id="cats" class="chips"></div>
  </section>

  <!-- Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø£ÙŠÙ…Ù†: Ø§Ù„ÙÙŠØ¯ÙŠÙˆ + Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù‚Ù†ÙˆØ§Øª -->
  <section class="panel">
    <div class="row" style="justify-content:space-between">
      <h3>Ø§Ù„Ù…Ø´ØºÙ„</h3>
      <div class="status" id="status">Ø¬Ø§Ù‡Ø²</div>
    </div>
    <video id="player" controls playsinline muted crossorigin="anonymous"></video>
    <div class="row" style="gap:8px; margin-top:8px">
      <button id="unmute" class="outline">ğŸ”Š ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª</button>
      <button id="reload" class="outline">â†» Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ØµØ¯Ø±</button>
      <span class="muted">* ÙŠØ¨Ø¯Ø£ ØµØ§Ù…ØªÙ‹Ø§ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ Ù„ØªØ¬Ø§ÙˆØ² Ø³ÙŠØ§Ø³Ø© Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ.</span>
    </div>

    <div class="row search" style="margin-top:10px">
      <input id="q" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ù‚Ù†Ø§Ø©..." style="flex:1">
      <select id="sort">
        <option value="name">Ø§Ù„Ø§Ø³Ù… (Ø£-ÙŠ)</option>
        <option value="id">Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¹Ø±Ù‘Ù</option>
      </select>
    </div>

    <h4 style="margin:10px 0 6px">Ø§Ù„Ù‚Ù†ÙˆØ§Øª</h4>
    <div id="streams" class="items list"></div>
  </section>
</main>

<div id="toast" class="toast" style="display:none"></div>

<script>
// ====== 1) Ø¹Ø¯Ù‘Ù„ Ù‡Ø°Ø§ Ù„Ùˆ ØªØºÙŠÙ‘Ø± Ø±Ø§Ø¨Ø· Ø§Ù„Ø¨Ø±ÙˆÙƒØ³ÙŠ Ù„Ø¯ÙŠÙƒ ======
const BASE_PROXY = "https://ai-core-proxy.bassam-7111111.workers.dev";

// ====== 2) Ù‚Ø±Ø§Ø¡Ø© Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Xtream Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø· Ø£Ùˆ localStorage ======
const url = new URL(location.href);
const state = {
  host: url.searchParams.get("host") || localStorage.getItem("xt_host") || "",
  u:    url.searchParams.get("u")    || localStorage.getItem("xt_u")    || "",
  p:    url.searchParams.get("p")    || localStorage.getItem("xt_p")    || "",
  catId: null,
  allStreams: [],
  lastSource: null,
};

const $ = (id)=>document.getElementById(id);
$("host").value = state.host;
$("user").value = state.u;
$("pass").value = state.p;

$("save").onclick = () => {
  state.host = $("host").value.trim();
  state.u    = $("user").value.trim();
  state.p    = $("pass").value.trim();
  localStorage.setItem("xt_host", state.host);
  localStorage.setItem("xt_u", state.u);
  localStorage.setItem("xt_p", state.p);
  loadCategories();
};

// Ø£Ø¯ÙˆØ§Øª
function setStatus(msg){ $("status").textContent = msg; }
function toast(msg){
  const t=$("toast"); t.textContent=msg; t.style.display='block';
  setTimeout(()=>{ t.style.display='none'; }, 2600);
}
function qp(obj){ return Object.entries(obj).map(([k,v])=>`${k}=${encodeURIComponent(v)}`).join("&"); }
function needCreds(){
  return !(state.host && state.u && state.p);
}

// ====== 3) Ø¬Ù„Ø¨ Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª ======
async function loadCategories(){
  if (needCreds()){ setStatus("Ø£Ø¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Xtream Ø«Ù… Ø§Ø¶ØºØ· Ø­ÙØ¸"); $("cats").innerHTML=""; $("streams").innerHTML=""; return; }
  setStatus("Ø¬Ù„Ø¨ Ø§Ù„ØªØµÙ†ÙŠÙØ§Øªâ€¦");
  $("cats").innerHTML = "â€¦";
  try{
    const qs = qp({
      host: state.host, u: state.u, p: state.p,
      endpoint: "player_api.php", action: "get_live_categories"
    });
    const res = await fetch(`${BASE_PROXY}/xtream?${qs}`);
    if(!res.ok) throw new Error("HTTP "+res.status);
    const cats = await res.json();

    $("cats").innerHTML = "";
    (cats||[]).forEach(c=>{
      const b = document.createElement("button");
      b.className = "chip";
      b.textContent = c.category_name || ("ØªØµÙ†ÙŠÙ #" + c.category_id);
      b.onclick = ()=> selectCategory(c.category_id, b);
      $("cats").appendChild(b);
    });

    setStatus("Ø¬Ø§Ù‡Ø² â€” Ø§Ø®ØªØ± ØªØµÙ†ÙŠÙÙ‹Ø§");
  }catch(e){
    setStatus("ØªØ¹Ø°Ø± Ø¬Ù„Ø¨ Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª");
    console.error(e);
    toast("ØªØ¹Ø°Ø± Ø¬Ù„Ø¨ Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨Ø±ÙˆÙƒØ³ÙŠ/Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.");
  }
}

// ====== 4) Ø§Ø®ØªÙŠØ§Ø± ØªØµÙ†ÙŠÙ Ø«Ù… Ø¬Ù„Ø¨ Ø§Ù„Ù‚Ù†ÙˆØ§Øª ======
async function selectCategory(category_id, btn){
  [...document.querySelectorAll(".chip")].forEach(x=>x.classList.remove("active"));
  btn.classList.add("active");
  state.catId = category_id;
  setStatus("Ø¬Ù„Ø¨ Ø§Ù„Ù‚Ù†ÙˆØ§Øªâ€¦");
  $("streams").innerHTML = "â€¦";
  try{
    const qs = qp({
      host: state.host, u: state.u, p: state.p,
      endpoint: "player_api.php", action: "get_live_streams",
      category_id
    });
    const res = await fetch(`${BASE_PROXY}/xtream?${qs}`);
    if(!res.ok) throw new Error("HTTP "+res.status);
    const streams = await res.json();
    state.allStreams = Array.isArray(streams) ? streams : [];
    renderStreams();
    setStatus(`ØªÙ… â€” ${state.allStreams.length} Ù‚Ù†Ø§Ø©`);
  }catch(e){
    setStatus("ØªØ¹Ø°Ø± Ø¬Ù„Ø¨ Ø§Ù„Ù‚Ù†ÙˆØ§Øª");
    console.error(e);
    toast("ØªØ¹Ø°Ø± Ø¬Ù„Ø¨ Ø§Ù„Ù‚Ù†ÙˆØ§Øª.");
  }
}

// ====== 5) Ø¹Ø±Ø¶ Ø§Ù„Ù‚Ù†ÙˆØ§Øª + Ø§Ù„Ø¨Ø­Ø« + Ø§Ù„ÙØ±Ø² ======
$("q").oninput = renderStreams;
$("sort").onchange = renderStreams;

function renderStreams(){
  const q = $("q").value.trim().toLowerCase();
  const sort = $("sort").value;
  let items = state.allStreams.slice();
  if (q) items = items.filter(s => (s.name||"").toLowerCase().includes(q));
  items.sort((a,b)=>{
    if (sort==="id") return (+a.stream_id||0) - (+b.stream_id||0);
    return (a.name||"").localeCompare(b.name||"");
  });

  $("streams").innerHTML = "";
  items.forEach(s=>{
    const div = document.createElement("div");
    div.className = "item";
    const badge = document.createElement("div");
    badge.className = "badge";
    badge.textContent = "#" + s.stream_id;
    const name = document.createElement("div");
    name.style.flex = "1";
    name.textContent = s.name || "Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…";
    const play = document.createElement("button");
    play.textContent = "ØªØ´ØºÙŠÙ„ â–¶";
    play.onclick = ()=> playStream(s.stream_id, s.name);

    div.appendChild(name);
    div.appendChild(badge);
    div.appendChild(play);
    $("streams").appendChild(div);
  });
}

// ====== 6) ØªØ´ØºÙŠÙ„ Ø§Ù„Ù‚Ù†Ø§Ø© Ø¹Ø¨Ø± xplay (HLS) ======
let hlsInstance = null;
const videoEl = $("player");

$("unmute").onclick = ()=>{
  videoEl.muted = false;
  videoEl.play().catch(()=>{});
};

$("reload").onclick = ()=>{
  if(state.lastSource) startVideo(state.lastSource, true);
};

function canNativeHLS(){
  const v = document.createElement("video");
  return v.canPlayType('application/vnd.apple.mpegURL') || v.canPlayType('application/x-mpegURL');
}

function buildHlsUrl(stream_id){
  // Ù†ÙˆØ¹ m3u8 Ø¹Ø¨Ø± Ø§Ù„Ø¨Ø±ÙˆÙƒØ³ÙŠ
  return `${BASE_PROXY}/xplay?${qp({
    host: state.host, u: state.u, p: state.p,
    stream: stream_id, type: "m3u8"
  })}`;
}

async function playStream(stream_id, label){
  const hlsUrl = buildHlsUrl(stream_id);
  state.lastSource = hlsUrl;
  setStatus(`ØªØ´ØºÙŠÙ„: ${label||('#'+stream_id)}`);
  startVideo(hlsUrl);
}

async function startVideo(hlsUrl, isReload=false){
  try{
    if (hlsInstance){ hlsInstance.destroy(); hlsInstance=null; }

    // ØªØ´ØºÙŠÙ„ Ù…ÙŠÙˆØª Ø£ÙˆÙ„Ù‹Ø§ Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„
    videoEl.muted = true;

    if (canNativeHLS()){
      videoEl.src = hlsUrl;
      await videoEl.play().catch(()=>{});
    }else{
      // Ø­Ù…Ù„ hls.js ÙÙ‚Ø· Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø©
      if (!window.Hls){
        await new Promise((ok,err)=>{
          const s=document.createElement("script");
          s.src="https://cdn.jsdelivr.net/npm/hls.js@latest";
          s.onload=ok; s.onerror=err; document.head.appendChild(s);
        });
      }
      if (window.Hls && window.Hls.isSupported()){
        hlsInstance = new Hls({ maxBufferLength: 10, enableWorker: true });
        hlsInstance.loadSource(hlsUrl);
        hlsInstance.attachMedia(videoEl);
        hlsInstance.on(Hls.Events.MANIFEST_PARSED, ()=> videoEl.play().catch(()=>{}));
        hlsInstance.on(Hls.Events.ERROR, (_, data)=>{
          console.warn("HLS error", data);
          if(data.fatal){
            toast("ØªØ¹Ø°Ø± ØªØ´ØºÙŠÙ„ Ø§Ù„Ù‚Ù†Ø§Ø©ØŒ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©â€¦");
            if(!isReload) startVideo(hlsUrl, true);
          }
        });
      }else{
        // Ø¢Ø®Ø± Ù…Ø­Ø§ÙˆÙ„Ø©
        videoEl.src = hlsUrl;
        await videoEl.play().catch(()=>{});
      }
    }
  }catch(e){
    console.error(e);
    toast("ØªØ¹Ø°Ø± ØªØ´ØºÙŠÙ„ Ø§Ù„Ù‚Ù†Ø§Ø©.");
  }
}

// ØªØ­Ù…ÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
loadCategories();
</script>
</body>
</html>
