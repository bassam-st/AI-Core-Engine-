<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>شاشة Xtream</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Tahoma,Arial; background:#0b0f17; color:#e9edf1; margin:0}
  header{padding:16px; background:#111827; border-bottom:1px solid #1f2937}
  .row{display:flex; gap:12px; flex-wrap:wrap; align-items:center}
  input,button,select{padding:10px 12px; border-radius:10px; border:1px solid #374151; background:#0f172a; color:#e5e7eb}
  button{cursor:pointer}
  button.primary{background:#2563eb; border-color:#1d4ed8}
  main{display:grid; grid-template-columns: 320px 1fr; gap:14px; padding:14px}
  @media (max-width: 950px){ main{display:block} }
  .panel{background:#0f172a; border:1px solid #1f2937; border-radius:14px; padding:12px}
  .chips{display:flex; gap:8px; flex-wrap:wrap; max-height:46vh; overflow:auto; padding:6px}
  .chip{border:1px solid #334155; background:#0b1220; border-radius:999px; padding:8px 12px; white-space:nowrap}
  .chip.active{background:#1d4ed8; border-color:#1d4ed8}
  .items{max-height:54vh; overflow:auto; padding-right:4px}
  .item{display:flex; align-items:center; gap:10px; padding:10px; border-radius:10px; border:1px solid #1f2937; background:#0b1220}
  .item:hover{background:#0d1528}
  .badge{font-size:12px; opacity:.75}
  video{width:100%; max-height:62vh; background:#000; border-radius:12px; border:1px solid #1f2937}
  .muted{opacity:.7; font-size:13px}
</style>
</head>
<body>
<header>
  <div class="row">
    <strong>🎯 شاشة Xtream</strong>
    <span class="muted">— أدخل بياناتك مرة ثم استمتع</span>
  </div>
</header>

<main>
  <section class="panel">
    <h3>إعدادات Xtream</h3>
    <div class="row" style="margin-top:8px">
      <input id="host" placeholder="host:port (مثال mhiptv.info:2095)" style="flex:1">
    </div>
    <div class="row">
      <input id="user" placeholder="اسم المستخدم u">
      <input id="pass" placeholder="كلمة المرور p" type="password">
      <button id="save" class="primary">حفظ/تحديث</button>
    </div>
    <p class="muted">تُحفظ محليًا (localStorage) ولا تحتاج إدخالها كل مرة.</p>

    <h3 style="margin-top:10px">التصنيفات</h3>
    <div id="cats" class="chips"></div>
  </section>

  <section class="panel">
    <div class="row" style="justify-content:space-between">
      <h3>المشغّل</h3>
      <div class="muted" id="status">جاهز</div>
    </div>
    <video id="player" controls playsinline></video>

    <h4 style="margin:10px 0 6px">القنوات</h4>
    <div class="row" style="gap:8px">
      <input id="q" placeholder="ابحث باسم القناة..." style="flex:1">
      <select id="sort">
        <option value="name">الاسم (أ-ي)</option>
        <option value="id">حسب المعرّف</option>
      </select>
    </div>
    <div id="streams" class="items"></div>
  </section>
</main>

<script>
const state = {
  host: localStorage.getItem("xt_host") || "",
  u:    localStorage.getItem("xt_u")    || "",
  p:    localStorage.getItem("xt_p")    || "",
  catId: null,
  allStreams: [],
};
const $ = (id)=>document.getElementById(id);
$("host").value = state.host;
$("user").value = state.u;
$("pass").value = state.p;

$("save").onclick = () => {
  state.host = $("host").value.trim();
  state.u    = $("user").value.trim();
  state.p    = $("pass").value.trim();
  localStorage.setItem("xt_host", state.host);
  localStorage.setItem("xt_u", state.u);
  localStorage.setItem("xt_p", state.p);
  loadCategories();
};

function setStatus(msg){ $("status").textContent = msg; }
function qp(obj){ return Object.entries(obj).map(([k,v])=>`${k}=${encodeURIComponent(v)}`).join("&"); }
function needCreds(){ return !(state.host && state.u && state.p); }

async function loadCategories(){
  if (needCreds()){ setStatus("أدخل بيانات Xtream ثم احفظ"); $("cats").innerHTML=""; $("streams").innerHTML=""; return; }
  setStatus("جلب التصنيفات…");
  $("cats").innerHTML = "…";
  try{
    const url = `/api/xtream/info`;
    const res = await fetch(url);
    const js  = await res.json();

    // إن أردت تصنيفات دقيقة، يمكنك لاحقاً استدعاء get_live_categories
    const catsRes = await fetch(`/api/xtream/channels`);
    const chData = await catsRes.json();
    const channels = chData.channels || [];
    // سنستنبط تصنيفات من الحقول المتاحة
    const map = new Map();
    for (const c of channels){
      const cat = c.category || "Other";
      if (!map.has(cat)) map.set(cat, []);
      map.get(cat).push(c);
    }
    $("cats").innerHTML = "";
    for (const [name, arr] of map.entries()){
      const b = document.createElement("button");
      b.className = "chip";
      b.textContent = `${name} (${arr.length})`;
      b.onclick = ()=> selectCategory(name, arr, b);
      $("cats").appendChild(b);
    }
    setStatus("جاهز — اختر تصنيفًا");
  }catch(e){ setStatus("تعذر جلب التصنيفات"); console.error(e); }
}

function selectCategory(catName, arr, btn){
  [...document.querySelectorAll(".chip")].forEach(x=>x.classList.remove("active"));
  btn.classList.add("active");
  state.catId = catName;
  state.allStreams = arr.slice();
  renderStreams();
}

$("q").oninput = renderStreams;
$("sort").onchange = renderStreams;

function renderStreams(){
  const box = $("streams");
  box.innerHTML = "";
  const q = $("q").value.trim().toLowerCase();
  const sort = $("sort").value;

  let items = state.allStreams.slice();
  if (q) items = items.filter(s => (s.name||"").toLowerCase().includes(q));
  items.sort((a,b)=> sort==="id" ? ((+a.stream_id||0)-(+b.stream_id||0)) : (a.name||"").localeCompare(b.name||""));

  for (const s of items){
    const row = document.createElement("div");
    row.className = "item";
    row.innerHTML = `
      <div style="flex:1">${s.name||"بدون اسم"}</div>
      <div class="badge">#${s.stream_id}</div>
      <button class="primary" onclick="play(${s.stream_id})">تشغيل ▶</button>
    `;
    box.appendChild(row);
  }
}

function canNativeHLS(){
  const v = document.createElement("video");
  return v.canPlayType('application/vnd.apple.mpegURL') || v.canPlayType('application/x-mpegURL');
}
async function startVideo(hlsUrl){
  const video = document.getElementById("player");
  if (canNativeHLS()){ video.src = hlsUrl; video.play().catch(()=>{}); return; }
  if (!window.Hls){
    await new Promise((ok,err)=>{ const s=document.createElement("script"); s.src="https://cdn.jsdelivr.net/npm/hls.js@latest"; s.onload=ok; s.onerror=err; document.head.appendChild(s); });
  }
  if (window.Hls && window.Hls.isSupported()){
    const hls = new window.Hls(); hls.loadSource(hlsUrl); hls.attachMedia(video);
    hls.on(window.Hls.Events.MANIFEST_PARSED, ()=> video.play().catch(()=>{}));
  }else{ video.src = hlsUrl; video.play().catch(()=>{}); }
}

function play(stream_id){
  const url = `/api/xtream/stream/${stream_id}.m3u8`; // بروكسي المانيفست
  startVideo(url);
  setStatus(`تشغيل: #${stream_id}`);
}

loadCategories();
</script>
</body>
</html>
