<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Ù…Ø¨Ø§Ø±ÙŠØ§Øª Ø§Ù„ÙŠÙˆÙ…</title>
<style>
  :root{--bg:#0f172a;--card:#0b1220;--text:#e2e8f0;--muted:#9fb0d6;--line:#1f2842;--btn:#111827;--ok:#10b981}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text);margin:0;padding:16px}
  .wrap{max-width:860px;margin:auto}
  h2{margin:6px 0 14px}
  .row{border:1px solid var(--line);border-radius:14px;padding:12px;margin:10px 0;background:var(--card)}
  .title{font-weight:700;font-size:16px}
  .sub{opacity:.9;font-size:13px;color:var(--muted)}
  .ctrl{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:10px}
  input,button,select{font-family:inherit}
  input{flex:1;padding:10px;border-radius:10px;border:1px solid var(--line);background:#0a1329;color:var(--text)}
  .btn{padding:9px 12px;border:0;border-radius:10px;background:var(--btn);color:#fff;cursor:pointer}
  .btn.play{background:var(--ok);color:#062116;font-weight:700}
  .badge{display:inline-block;padding:4px 8px;border-radius:9999px;background:#E6F6EE;color:#0F9D58;font-weight:600;font-size:.85rem;margin:2px 4px;text-decoration:none}
  .pill{display:inline-block;padding:2px 8px;border-radius:9999px;background:#15213d;border:1px solid var(--line);font-size:12px;margin-inline-start:6px}
  .live{color:#ff7676;font-weight:700}
  .hr{height:1px;background:var(--line);margin:10px 0}
  .muted{color:var(--muted);font-size:12px}
  .flex{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
</style>
</head>
<body>
<div class="wrap">
  <h2>ğŸŸï¸ Ù…Ø¨Ø§Ø±ÙŠØ§Øª Ø§Ù„ÙŠÙˆÙ…</h2>

  <div class="ctrl">
    <input id="league" placeholder="ÙÙ„ØªØ±Ø© Ø§Ù„Ø¯ÙˆØ±ÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"/>
    <input id="q" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„ÙØ±Ù‚ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"/>
    <label class="flex" style="gap:6px"><input type="checkbox" id="liveOnly"/> Ù„Ø§ÙŠÙ Ø§Ù„Ø¢Ù†</label>
    <label class="flex" style="gap:6px"><input type="checkbox" id="auto" checked/> ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠ</label>
    <button class="btn" onclick="load()">ØªØ­Ø¯ÙŠØ«</button>
  </div>

  <div id="sources" class="flex" style="margin:8px 0;"></div>
  <div class="hr"></div>
  <div id="list"></div>
  <p class="muted">Ø§Ø¶ØºØ· â€œØªØ´ØºÙŠÙ„ Ù…Ø¨Ø§Ø´Ø±â€ Ù„ÙØªØ­ Ø§Ù„Ù…Ø´ØºÙ„ Ø¯Ø§Ø®Ù„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚. Ø¥Ù† ÙƒØ§Ù† Ù„Ø¯ÙŠÙƒ Ø§Ø´ØªØ±Ø§Ùƒ Xtream ÙˆØªÙ… ØªÙ…Ø±ÙŠØ± <code>xtreamStreamId</code> Ù„Ù„Ù…Ø¨Ø§Ø±Ø§Ø©ØŒ Ø§Ø³ØªØ®Ø¯Ù… Ø²Ø± â€œØªØ´ØºÙŠÙ„ Ø¹Ø¨Ø± Xtreamâ€.</p>
</div>

<script>
let allMatches = [];
let autoIv = null;

function badge(name,url){ return `<a class="badge" href="${url}" target="_blank" rel="noopener">${name}</a>`; }

async function load(){
  try{
    const lg = document.getElementById('league').value || "";
    const url = lg ? `/api/sports/today?league=${encodeURIComponent(lg)}` : `/api/sports/today`;
    const r = await fetch(url);
    const data = await r.json();

    allMatches = Array.isArray(data.matches) ? data.matches : [];

    const srcDiv = document.getElementById('sources');
    srcDiv.innerHTML = (data.sources||[])
      .map(s=>badge(s.name || s.title || 'Ù…ØµØ¯Ø±', s.url || s.link || '#'))
      .join("");

    render();
    setupAuto();
  }catch(e){
    alert('ØªØ¹Ø°Ù‘Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¨Ø§Ø±ÙŠØ§Øª');
    console.error(e);
  }
}

function setupAuto(){
  const auto = document.getElementById('auto').checked;
  if(auto && !autoIv){
    autoIv = setInterval(load, 60000); // ÙƒÙ„ 60 Ø«Ø§Ù†ÙŠØ©
  }else if(!auto && autoIv){
    clearInterval(autoIv); autoIv = null;
  }
}

function isLive(m){
  const t = (m.time||"").toLowerCase();
  return ["live","Ù…Ø¨Ø§Ø´Ø±","Ø­ÙŠ","Ù‚ÙŠØ¯ Ø§Ù„Ù„Ø¹Ø¨","Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡","now","ongoing"].some(x=>t.includes(x));
}

function pass(v){ return v!==undefined && v!==null && v!==""; }

function render(){
  const list = document.getElementById('list');
  list.innerHTML = "";
  const liveOnly = document.getElementById('liveOnly').checked;
  const q = (document.getElementById('q').value || "").trim().toLowerCase();

  let items = allMatches.slice();
  if(liveOnly) items = items.filter(isLive);
  if(q) items = items.filter(m => ((m.home||"")+ (m.away||"")+ (m.league||"")).toLowerCase().includes(q));

  if(!items.length){
    list.innerHTML = `<div class="row">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¨Ø§Ø±ÙŠØ§Øª Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„Ø¢Ù†.</div>`;
    return;
  }

  for(const m of items){
    const div = document.createElement('div');
    div.className = "row";

    const liveTag = isLive(m) ? `<span class="live pill">Ù…Ø¨Ø§Ø´Ø± Ø§Ù„Ø¢Ù†</span>` : "";
    const league = pass(m.league) ? `<span class="pill">${m.league}</span>` : "";
    const time   = pass(m.time)   ? `<span class="pill">${m.time}</span>`   : "";

    const srcBtn = (m.source && (m.source.url||m.source.link))
      ? `<a class="badge" href="${m.source.url || m.source.link}" target="_blank" rel="noopener">Ø§Ù„Ù…ØµØ¯Ø±</a>` : "";

    // Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ´ØºÙŠÙ„
    let playBtns = "";
    if (pass(m.streamUrl)) {
      playBtns += `<button class="btn play" onclick="playDirect('${encodeURIComponent(m.streamUrl)}')">ØªØ´ØºÙŠÙ„ Ù…Ø¨Ø§Ø´Ø±</button>`;
    }
    if (pass(m.xtreamStreamId)) {
      playBtns += `<button class="btn" onclick="playViaXtream('${m.xtreamStreamId}')">ØªØ´ØºÙŠÙ„ Ø¹Ø¨Ø± Xtream</button>`;
    }

    div.innerHTML = `
      <div class="title">${m.home || "?"} Ã— ${m.away || "?"}</div>
      <div class="sub" style="margin:6px 0">${league} ${time} ${liveTag}</div>
      <div class="flex" style="margin-top:6px">
        ${playBtns || '<span class="muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ø§Ø¨Ø· Ø¨Ø« Ù…ØªØ§Ø­ Ø­Ø§Ù„ÙŠØ§Ù‹.</span>'}
        ${srcBtn}
      </div>
    `;
    list.appendChild(div);
  }
}

function playDirect(encodedUrl){
  const url = decodeURIComponent(encodedUrl);
  if(url && url.startsWith('http')){
    window.location.href = "/ui/sports_player?url=" + encodeURIComponent(url);
  }else{
    alert("Ø§Ù„Ø±Ø§Ø¨Ø· ØºÙŠØ± ØµØ§Ù„Ø­.");
  }
}

async function playViaXtream(streamId){
  try{
    const r = await fetch(`/api/xtream/build?stream_id=${encodeURIComponent(streamId)}`);
    const data = await r.json();
    if(!data.ok || !data.url){
      alert(data.error || "ØªØ¹Ø°Ø± ØªÙˆÙ„ÙŠØ¯ Ø±Ø§Ø¨Ø· Xtream");
      return;
    }
    window.location.href = "/ui/sports_player?url=" + encodeURIComponent(data.url);
  }catch(e){
    alert("ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø®Ø§Ø¯Ù… Xtream"); console.error(e);
  }
}

document.getElementById('liveOnly').addEventListener('change', render);
document.getElementById('q').addEventListener('input', render);
document.getElementById('auto').addEventListener('change', setupAuto);

// Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ÙˆÙ„ÙŠ
load();
</script>
</body>
</html>
