<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ù†ÙˆØ§Ø© Ø¨Ø³Ù‘Ø§Ù… Ø§Ù„Ø°ÙƒÙŠØ©</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
      background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      min-height:100vh;display:flex;justify-content:center;align-items:center;padding:16px
    }
    .chat-container{
      width:100%;max-width:420px;height:84vh;background:#fff;border-radius:20px;
      box-shadow:0 10px 30px rgba(0,0,0,.25);display:flex;flex-direction:column;overflow:hidden
    }
    .chat-header{
      background:linear-gradient(135deg,#10b981,#0ea5e9);
      color:#fff;padding:18px 20px;text-align:center;border-radius:20px 20px 0 0
    }
    .chat-header h1{font-size:1.35rem;margin-bottom:4px}
    .chat-header p{font-size:.9rem;opacity:.95}

    .chat-messages{flex:1;padding:16px;overflow-y:auto;background:#f6f7fb}
    .message{
      max-width:82%;margin-bottom:12px;padding:12px 14px;border-radius:18px;position:relative;
      animation:fadeIn .25s ease-in
    }
    @keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}

    .user-message{
      background:#10b981;color:#fff;margin-left:auto;border-bottom-right-radius:6px;text-align:left
    }
    .bot-message{
      background:#fff;color:#333;border:1px solid #e6e6ea;margin-right:auto;border-bottom-left-radius:6px;text-align:right
    }
    .bot-message b{color:#0ea5e9}
    .bot-message a{color:#16a34a;text-decoration:underline}
    .bot-message a:hover{filter:brightness(1.15)}
    .bot-message hr{border:0;height:1px;background:#ececf2;margin:10px 0}

    .message-time{font-size:.72rem;opacity:.7;margin-top:6px;text-align:right}
    .user-message .message-time{text-align:left}

    .typing{display:none;margin-right:auto;background:#fff;color:#666;border:1px solid #eee;
      border-bottom-left-radius:6px;padding:8px 12px;border-radius:14px}

    .chat-input-wrap{padding:12px;background:#fff;border-top:1px solid #ececf2;display:flex;gap:8px;align-items:center}
    .chat-input{flex:1;padding:12px 14px;border:1px solid #ddd;border-radius:24px;outline:none;font-size:14px}
    .chat-input:focus{border-color:#10b981}
    .send-btn{
      background:#10b981;color:#fff;border:0;border-radius:50%;width:44px;height:44px;cursor:pointer;
      display:flex;align-items:center;justify-content:center;transition:.2s
    }
    .send-btn:hover{transform:scale(1.03)}
    .select-style{
      border:1px solid #ddd;border-radius:12px;padding:8px 10px;background:#f9fafb;font-size:.9rem;color:#333
    }
    @media (max-width:480px){.chat-container{height:90vh}}
  </style>
</head>
<body>
  <div class="chat-container">
    <div class="chat-header">
      <h1>ğŸ§  Ù†ÙˆØ§Ø© Ø¨Ø³Ù‘Ø§Ù…</h1>
      <p>Ø°ÙƒÙŠ â€¢ Ù…ØªØ¹Ù„Ù… â€¢ Ø¨Ø­Ø« Ù…Ø¨Ø§Ø´Ø± Ù…Ù† Ø§Ù„ÙˆÙŠØ¨ + ÙˆÙŠÙƒÙŠ</p>
    </div>

    <div class="chat-messages" id="messages">
      <div class="message bot-message">
        Ù…Ø±Ø­Ø¨Ù‹Ø§! ğŸ‘‹ Ø§Ø³Ø£Ù„Ù†ÙŠ Ø£ÙŠ Ø´ÙŠØ¡ØŒ Ø³Ø£Ø¬Ù…Ø¹ Ø£ÙØ¶Ù„ Ø§Ù„Ù†Ù‚Ø§Ø· Ù…Ù† Ø§Ù„ÙˆÙŠØ¨ ÙˆÙˆÙŠÙƒÙŠØ¨ÙŠØ¯ÙŠØ§ ÙˆØ£Ø±ØªØ¨Ù‡Ø§ Ù…Ø¹ Ù…ØµØ§Ø¯Ø± Ø®Ø¶Ø±Ø§Ø¡ ÙˆØ§Ø¶Ø­Ø©.
        <div class="message-time" id="helloTime"></div>
      </div>
    </div>

    <div class="typing" id="typing">ÙŠÙƒØªØ¨ Ø§Ù„Ø¢Ù†â€¦</div>

    <div class="chat-input-wrap">
      <select id="styleSel" class="select-style" title="Ø£Ø³Ù„ÙˆØ¨ Ø§Ù„Ø±Ø¯">
        <option value="">Ø£Ø³Ù„ÙˆØ¨ Ø§ÙØªØ±Ø§Ø¶ÙŠ</option>
        <option value="friendly">ÙˆØ¯ÙˆØ¯</option>
        <option value="formal">Ø±Ø³Ù…ÙŠ</option>
        <option value="brief">Ù…Ø®ØªØµØ±</option>
      </select>
      <input id="inp" class="chat-input" type="text" placeholder="Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ Ù‡Ù†Ø§â€¦" maxlength="500"/>
      <button class="send-btn" id="sendBtn" aria-label="Ø¥Ø±Ø³Ø§Ù„">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
          <path d="M2 21L23 12L2 3V10L17 12L2 14V21Z" fill="white"/>
        </svg>
      </button>
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);
    const messages = $('messages');
    const typing = $('typing');
    const inp = $('inp');
    const styleSel = $('styleSel');

    function nowTime(){
      const d = new Date();
      return d.toLocaleTimeString('ar-EG',{hour:'2-digit',minute:'2-digit',hour12:true});
    }
    $('helloTime').textContent = nowTime();

    function addMsg(html, who='bot'){
      const div = document.createElement('div');
      div.className = `message ${who==='user'?'user-message':'bot-message'}`;
      div.innerHTML = html + `<div class="message-time">${nowTime()}</div>`;
      messages.appendChild(div);
      messages.scrollTop = messages.scrollHeight;
    }

    async function send(){
      const q = inp.value.trim();
      if(!q) return;
      addMsg(q,'user');
      inp.value = '';
      typing.style.display = 'block';
      messages.scrollTop = messages.scrollHeight;

      try{
        const res = await fetch('/ask-live', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ message: q, style: styleSel.value || null })
        });
        const data = await res.json();
        typing.style.display = 'none';

        if(!data.ok){
          addMsg(`âŒ Ø­Ø¯Ø« Ø®Ø·Ø£<br><small>${(data.error||'Ø£Ø¹Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©')}</small>`,'bot');
          return;
        }

        // Ø¬ÙˆØ§Ø¨ Ø§Ù„Ù…ÙˆÙ„Ù‘Ø¯ (ÙŠØ­ÙˆÙŠ Ø£Ù‚Ø³Ø§Ù… ÙˆÙÙˆØ§ØµÙ„). Ù†Ø³Ù…Ø­ Ø¨Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ø®Ø¶Ø±Ø§Ø¡ Ø§Ù„Ù‚Ø§Ø¯Ù…Ø© Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±.
        let html = (data.answer || '').replace(/\n/g,'<br>');

        // Ø¥Ù† ÙƒØ§Ù†Øª Ù‡Ù†Ø§Ùƒ Ù‚Ø§Ø¦Ù…Ø© Ù…ØµØ§Ø¯Ø±ØŒ Ù†Ø¹Ø±Ø¶Ù‡Ø§ Ø£Ø³ÙÙ„ Ø§Ù„Ø±Ø¯ Ø£ÙŠØ¶Ù‹Ø§.
        if(Array.isArray(data.sources) && data.sources.length){
          const items = data.sources.map(s => {
            const title = s.title || s.link || '';
            const href = s.link || s.href || '';
            return `<li><a href="${href}" target="_blank" rel="noopener">${title}</a></li>`;
          }).join('');
          html += `<hr><b>Ø§Ù„Ù…ØµØ§Ø¯Ø±:</b><ul style="padding-right:18px;margin-top:6px">${items}</ul>`;
        }

        addMsg(html,'bot');
      }catch(e){
        typing.style.display = 'none';
        addMsg(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…<br><small>ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª Ø«Ù… Ø­Ø§ÙˆÙ„ Ø«Ø§Ù†ÙŠØ©</small>`,'bot');
      }
    }

    $('sendBtn').addEventListener('click', send);
    inp.addEventListener('keydown', (e)=>{ if(e.key==='Enter') send(); });
    inp.focus();
  </script>
</body>
</html>
