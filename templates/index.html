<!doctype html>
<meta charset="utf-8" />
<title>Al Core Engine — Free Brain</title>
<link rel="stylesheet" href="/static/style.css" />
<div class="wrap">
  <h1>النواة الذكية — مجانية وبدون مفاتيح</h1>
  <div id="chat"></div>
  <form id="f">
    <input id="msg" placeholder="اكتب سؤالك هنا..." />
    <button>إرسال</button>
  </form>

  <div class="row">
    <button id="learnBtn">تعلّمي الآن (Autolearn)</button>
    <input id="fact" placeholder="أضف معلومة يدوية..." />
    <button id="saveFact">حفظ المعلومة</button>
  </div>

  <div class="sources" id="sources"></div>
</div>
<script>
const chat = document.getElementById('chat');
const f = document.getElementById('f');
const msg = document.getElementById('msg');
const sources = document.getElementById('sources');
const learnBtn = document.getElementById('learnBtn');
const fact = document.getElementById('fact');
const saveFact = document.getElementById('saveFact');

f.addEventListener('submit', async (e) => {
  e.preventDefault();
  const q = msg.value.trim();
  if(!q) return;
  chat.innerHTML += `<div class="you">${q}</div>`;
  msg.value = "";
  const r = await fetch('/api/chat', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({message: q})
  });
  const j = await r.json();
  chat.innerHTML += `<div class="bot">${(j.reply||'').replace(/\n/g,'<br>')}</div>`;
  sources.innerHTML = (j.sources||[]).map(s=>`<a target="_blank" href="${s.url}">🔗 ${s.title}</a>`).join(' ');
});

learnBtn.addEventListener('click', async () => {
  learnBtn.disabled = true;
  learnBtn.textContent = "تعمل...";
  try{
    const r = await fetch('/api/autolearn/run', {method:'POST'});
    const j = await r.json();
    chat.innerHTML += `<div class="bot">تم التعلّم الذاتي: أضفت ${j.added||0} جملة معرفة.</div>`;
  } finally {
    learnBtn.disabled = false;
    learnBtn.textContent = "تعلّمي الآن (Autolearn)";
  }
});

saveFact.addEventListener('click', async () => {
  const t = fact.value.trim();
  if(!t) return;
  const r = await fetch('/api/learn', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({text: t, source: "manual"})
  });
  fact.value = "";
  chat.innerHTML += `<div class="bot">تم حفظ المعلومة في الذاكرة ✅</div>`;
});
</script>
